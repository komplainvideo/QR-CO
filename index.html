<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="QR Counter">
  <title>QR Counter</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{--bg:#0a0a0f;--card:#13131a;--border:#1e1e2e;--accent:#00ff88;--accent2:#ff6b35;--text:#e8e8f0;--muted:#6b6b80;--danger:#ff4466;--warn:#ffaa00}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,sans-serif;min-height:100vh}
    body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,255,136,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,136,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
    .app{position:relative;z-index:1;max-width:420px;margin:0 auto;padding:20px 16px 40px}
    .header{text-align:center;padding:20px 0 12px}
    .header h1{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--accent),#00ccff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:var(--muted);font-size:0.8rem;margin-top:4px;font-family:monospace}
    .status-bar{text-align:center;font-size:0.75rem;font-family:monospace;padding:8px 12px;margin-bottom:8px;background:var(--card);border:1px solid var(--border);border-radius:10px}
    .status-bar.ready{color:var(--accent);border-color:rgba(0,255,136,0.3)}
    .status-bar.error{color:var(--danger);border-color:rgba(255,68,102,0.3)}
    .status-bar.scanning{color:#00ccff;border-color:rgba(0,204,255,0.3)}
    .dup-alert{display:none;background:rgba(255,50,50,0.15);border:2px solid var(--danger);border-radius:16px;padding:16px;text-align:center;margin:10px 0}
    .dup-alert.show{display:block;animation:popIn 0.3s ease}
    @keyframes popIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
    .dup-alert .d-icon{font-size:2rem}
    .dup-alert .d-title{font-size:1rem;font-weight:800;color:var(--danger);margin-top:4px}
    .dup-alert .d-data{font-size:0.72rem;color:#ffaaaa;font-family:monospace;margin-top:6px;word-break:break-all}
    .dup-alert .d-count{font-size:0.8rem;color:var(--warn);margin-top:4px;font-weight:700}
    .counter-display{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px 20px;text-align:center;margin:10px 0;position:relative;overflow:hidden}
    .counter-display::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
    .counter-number{font-size:5rem;font-weight:800;font-family:monospace;color:var(--accent);line-height:1;transition:all 0.15s ease}
    .counter-number.bump{transform:scale(1.2)}
    .counter-number.warn{color:var(--danger)!important}
    .counter-label{font-size:0.7rem;letter-spacing:4px;color:var(--muted);margin-top:8px;font-family:monospace}
    .last-scan{font-size:0.72rem;color:var(--muted);margin-top:8px;font-family:monospace;padding:6px 10px;background:rgba(0,255,136,0.05);border-radius:8px;display:none;word-break:break-all}
    .last-scan.show{display:block}
    .last-scan span{color:var(--accent)}
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:10px 0}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 4px;text-align:center}
    .stat-card.d{border-color:rgba(255,68,102,0.4);background:rgba(255,68,102,0.05)}
    .stat-card .sv{font-size:1.2rem;font-weight:800;font-family:monospace;color:var(--accent)}
    .stat-card.d .sv{color:var(--danger)}
    .stat-card .sl{font-size:0.55rem;color:var(--muted);letter-spacing:1px;margin-top:2px}
    .toggle-row{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin:10px 0;cursor:pointer;user-select:none}
    .toggle-row:active{opacity:0.8}
    .toggle-info .ti{font-size:0.85rem;font-weight:700;color:var(--text)}
    .toggle-info .ts{font-size:0.7rem;color:var(--muted);margin-top:2px;font-family:monospace}
    .toggle-switch{position:relative;width:54px;height:28px;flex-shrink:0;margin-left:12px}
    .toggle-track{position:absolute;inset:0;border-radius:28px;transition:background 0.3s}
    .toggle-thumb{position:absolute;top:3px;height:22px;width:22px;background:white;border-radius:50%;transition:left 0.3s;box-shadow:0 1px 4px rgba(0,0,0,0.4)}
    .btn-row{display:flex;gap:10px;margin:10px 0}
    .btn{flex:1;padding:15px;border:none;border-radius:14px;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:6px;-webkit-tap-highlight-color:transparent}
    .btn:active{opacity:0.8;transform:scale(0.97)}
    .btn-primary{background:var(--accent);color:#0a0a0f}
    .btn-stop{background:var(--danger);color:#fff}
    .btn-manual{background:var(--accent2);color:#fff}
    .btn-reset{background:var(--card);color:var(--muted);border:1px solid var(--border)}
    #scanner-wrapper{display:none;border-radius:20px;overflow:hidden;margin:12px 0;border:2px solid var(--accent);box-shadow:0 0 30px rgba(0,255,136,0.2);position:relative;background:#000}
    #scanner-wrapper.active{display:block}
    #scanner-wrapper.dup-mode{border-color:var(--danger)!important;box-shadow:0 0 30px rgba(255,68,102,0.4)!important}
    #scanner-video{width:100%;display:block;max-height:320px;object-fit:cover}
    .scan-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .scan-frame{width:190px;height:190px;position:relative}
    .sf-tl,.sf-tr,.sf-br,.sf-bl{position:absolute;width:28px;height:28px;border-color:var(--accent);border-style:solid}
    .sf-tl{top:0;left:0;border-width:3px 0 0 3px}
    .sf-tr{top:0;right:0;border-width:3px 3px 0 0}
    .sf-br{bottom:0;right:0;border-width:0 3px 3px 0}
    .sf-bl{bottom:0;left:0;border-width:0 0 3px 3px}
    .scan-line{position:absolute;left:10px;right:10px;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scanLine 2s linear infinite;box-shadow:0 0 8px var(--accent)}
    @keyframes scanLine{0%{top:10px}100%{top:calc(100% - 12px)}}
    .scan-status{position:absolute;bottom:0;left:0;right:0;text-align:center;font-size:0.85rem;font-weight:700;font-family:monospace;background:rgba(0,0,0,0.7);padding:10px;color:var(--accent)}
    .scan-status.dup{color:var(--danger)}
    .success-flash,.danger-flash{position:fixed;inset:0;pointer-events:none;z-index:999;opacity:0;transition:opacity 0.15s}
    .success-flash{background:rgba(0,255,136,0.08)}
    .danger-flash{background:rgba(255,50,50,0.15)}
    .success-flash.show,.danger-flash.show{opacity:1}
    .history-section{margin:12px 0}
    .history-title{font-size:0.7rem;letter-spacing:3px;color:var(--muted);font-family:monospace;margin-bottom:8px}
    .history-list{max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:4px}
    .history-item{display:flex;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:0.72rem;font-family:monospace;animation:slideIn 0.25s ease}
    .history-item.dup{border-color:rgba(255,68,102,0.4);background:rgba(255,68,102,0.05)}
    @keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
    .hi-num{color:var(--accent);font-weight:700;margin-right:6px;flex-shrink:0}
    .hi-dup{color:var(--danger);font-size:0.6rem;margin-right:4px;flex-shrink:0}
    .hi-data{color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:6px}
    .hi-time{color:var(--muted);font-size:0.62rem;flex-shrink:0}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:100;display:none;align-items:flex-end}
    .modal-overlay.show{display:flex}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:24px;width:100%;animation:slideUp 0.25s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal h3{font-size:1.1rem;font-weight:800;margin-bottom:16px}
    .modal input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:monospace;font-size:0.9rem;outline:none;margin-bottom:12px}
    .modal input:focus{border-color:var(--accent)}
    .modal-btns{display:flex;gap:10px}
    .modal-btns .btn{flex:1}
  </style>
</head>
<body>

<div class="success-flash" id="flashOk"></div>
<div class="danger-flash" id="flashWarn"></div>

<div class="app">
  <div class="header">
    <h1>‚¨° QR COUNTER</h1>
    <p>// scan & tally QR codes</p>
  </div>

  <div class="status-bar" id="statusBar">‚è≥ Memuat...</div>

  <div class="dup-alert" id="dupAlert">
    <div class="d-icon">‚ö†Ô∏è</div>
    <div class="d-title">‚õî SCAN DOBEL TERDETEKSI!</div>
    <div class="d-data" id="dupData">‚Äî</div>
    <div class="d-count" id="dupCount">Sudah di-scan 2x</div>
  </div>

  <div class="counter-display">
    <div class="counter-number" id="counterNum">0</div>
    <div class="counter-label">TOTAL SCAN</div>
    <div class="last-scan" id="lastScan">Last: <span id="lastData">‚Äî</span></div>
  </div>

  <div class="stats-row">
    <div class="stat-card"><div class="sv" id="statTotal">0</div><div class="sl">TOTAL</div></div>
    <div class="stat-card"><div class="sv" id="statUniq">0</div><div class="sl">UNIK</div></div>
    <div class="stat-card d"><div class="sv" id="statDupl">0</div><div class="sl">DOBEL‚ö†Ô∏è</div></div>
    <div class="stat-card"><div class="sv" id="statManual">0</div><div class="sl">MANUAL</div></div>
  </div>

  <!-- TOGGLE PERINGATAN DOBEL -->
  <div class="toggle-row" id="toggleRow">
    <div class="toggle-info">
      <div class="ti">‚ö†Ô∏è Peringatan Scan Dobel</div>
      <div class="ts">Nada + banner saat QR sama di-scan lagi</div>
    </div>
    <div class="toggle-switch">
      <div class="toggle-track" id="toggleTrack" style="background:var(--accent)"></div>
      <div class="toggle-thumb" id="toggleThumb" style="left:29px"></div>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn btn-primary" id="btnScan">üì∑ Mulai Scan QR</button>
  </div>

  <div id="scanner-wrapper">
    <video id="scanner-video" autoplay muted playsinline webkit-playsinline></video>
    <div class="scan-overlay">
      <div class="scan-frame">
        <div class="sf-tl"></div><div class="sf-tr"></div>
        <div class="sf-br"></div><div class="sf-bl"></div>
        <div class="scan-line"></div>
      </div>
    </div>
    <div class="scan-status" id="scanStatus">üîç Arahkan ke QR Code...</div>
  </div>

  <div class="btn-row">
    <button class="btn btn-manual" id="btnManual">‚ûï Manual</button>
    <button class="btn btn-reset" id="btnReset">üîÑ Reset</button>
  </div>

  <div class="history-section" id="historySection" style="display:none">
    <div class="history-title">// RIWAYAT SCAN</div>
    <div class="history-list" id="historyList"></div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>‚ûï Tambah Manual</h3>
    <input type="text" id="manualInput" placeholder="Masukkan data / kode...">
    <div class="modal-btns">
      <button class="btn btn-reset" id="modalCancel">Batal</button>
      <button class="btn btn-manual" id="modalConfirm">Tambah</button>
    </div>
  </div>
</div>

<!-- ALL JS AT THE BOTTOM - after all HTML elements exist -->
<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var count=0, manualCount=0, scannedData={};
var scanning=false, stream=null, raf=null;
var lastScanned='', lastScannedTime=0;
var audioCtx=null, detector=null, scanMethod='none';
var dupWarningOn=true, dupTimeout=null;

// ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var statusBar    = document.getElementById('statusBar');
var counterNum   = document.getElementById('counterNum');
var lastScanEl   = document.getElementById('lastScan');
var lastDataEl   = document.getElementById('lastData');
var scanWrapper  = document.getElementById('scanner-wrapper');
var scanVideo    = document.getElementById('scanner-video');
var scanStatus   = document.getElementById('scanStatus');
var btnScan      = document.getElementById('btnScan');
var histSection  = document.getElementById('historySection');
var histList     = document.getElementById('historyList');
var dupAlert     = document.getElementById('dupAlert');
var dupDataEl    = document.getElementById('dupData');
var dupCountEl   = document.getElementById('dupCount');
var flashOk      = document.getElementById('flashOk');
var flashWarn    = document.getElementById('flashWarn');
var toggleTrack  = document.getElementById('toggleTrack');
var toggleThumb  = document.getElementById('toggleThumb');
var toggleRow    = document.getElementById('toggleRow');

// ‚îÄ‚îÄ Toggle duplicate warning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
toggleRow.addEventListener('click', function(){
  dupWarningOn = !dupWarningOn;
  toggleTrack.style.background = dupWarningOn ? 'var(--accent)' : '#444';
  toggleThumb.style.left       = dupWarningOn ? '29px' : '3px';
});

// ‚îÄ‚îÄ Init BarcodeDetector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initScanner(){
  if('BarcodeDetector' in window){
    try{
      var fmts = await BarcodeDetector.getSupportedFormats();
      if(fmts.includes('qr_code')){
        detector = new BarcodeDetector({formats:['qr_code','aztec','data_matrix','code_128','code_39','ean_13','ean_8','upc_a','upc_e']});
        scanMethod = 'barcodedetector';
        statusBar.textContent = '‚úÖ Scanner siap (Mode Native)';
        statusBar.className = 'status-bar ready';
        setTimeout(function(){ statusBar.style.display='none'; }, 2000);
        return;
      }
    }catch(e){}
  }
  statusBar.textContent = '‚ùå Gunakan Chrome terbaru di Android.';
  statusBar.className = 'status-bar error';
}
initScanner();

// ‚îÄ‚îÄ Audio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initAudio(){
  if(!audioCtx) audioCtx = new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
}
document.addEventListener('touchstart', function(){ initAudio(); }, {once:true});

function playBeepOK(){
  try{
    initAudio();
    var t=audioCtx.currentTime;
    [[1800,0,0.12],[2400,0.15,0.30]].forEach(function(p){
      var o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type='square'; o.frequency.setValueAtTime(p[0],t+p[1]);
      g.gain.setValueAtTime(0.8,t+p[1]);
      g.gain.exponentialRampToValueAtTime(0.001,t+p[2]);
      o.start(t+p[1]); o.stop(t+p[2]);
    });
  }catch(e){}
}

function playBeepWARN(){
  try{
    initAudio();
    var t=audioCtx.currentTime;
    [0, 0.22, 0.44].forEach(function(start){
      var o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type='sawtooth';
      o.frequency.setValueAtTime(320,t+start);
      o.frequency.linearRampToValueAtTime(180,t+start+0.18);
      g.gain.setValueAtTime(1.0,t+start);
      g.gain.exponentialRampToValueAtTime(0.001,t+start+0.20);
      o.start(t+start); o.stop(t+start+0.20);
    });
  }catch(e){}
}

// ‚îÄ‚îÄ Visual helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doFlashOK(){ flashOk.classList.add('show'); setTimeout(function(){ flashOk.classList.remove('show'); },200); }
function doFlashWARN(){ flashWarn.classList.add('show'); setTimeout(function(){ flashWarn.classList.remove('show'); },400); }

function doBump(isWarn){
  counterNum.classList.remove('bump','warn');
  void counterNum.offsetWidth; // reflow
  counterNum.classList.add('bump');
  if(isWarn) counterNum.classList.add('warn');
  setTimeout(function(){ counterNum.classList.remove('bump','warn'); },200);
}

function showDupBanner(data, times){
  dupDataEl.textContent = data.length>40 ? data.slice(0,40)+'...' : data;
  dupCountEl.textContent = '‚ö†Ô∏è QR ini sudah di-scan '+times+'x!';
  dupAlert.classList.add('show');
  scanWrapper.classList.add('dup-mode');
  if(dupTimeout) clearTimeout(dupTimeout);
  dupTimeout = setTimeout(function(){
    dupAlert.classList.remove('show');
    scanWrapper.classList.remove('dup-mode');
  }, 3000);
}

// ‚îÄ‚îÄ Add scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addScan(data, isManual){
  var now = new Date();
  var ts = now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  var isDup = (scannedData[data] > 0);
  count++;
  scannedData[data] = (scannedData[data]||0)+1;
  if(isManual) manualCount++;

  counterNum.textContent = count;

  if(isDup && dupWarningOn){
    doBump(true);
    doFlashWARN();
    playBeepWARN();
    showDupBanner(data, scannedData[data]);
    if(navigator.vibrate) navigator.vibrate([100,50,100,50,100]);
    scanStatus.className='scan-status dup';
    scanStatus.textContent='‚õî DOBEL! '+(data.length>20?data.slice(0,20)+'‚Ä¶':data);
    setTimeout(function(){ if(scanning){ scanStatus.className='scan-status'; scanStatus.textContent='üîç Arahkan ke QR Code...'; } },2000);
  } else {
    doBump(false);
    doFlashOK();
    playBeepOK();
    if(navigator.vibrate) navigator.vibrate([80,40,80]);
  }

  lastDataEl.textContent = data.length>30 ? data.slice(0,30)+'...' : data;
  lastScanEl.classList.add('show');

  var uniq = Object.keys(scannedData).length;
  document.getElementById('statTotal').textContent  = count;
  document.getElementById('statUniq').textContent   = uniq;
  document.getElementById('statDupl').textContent   = count-uniq;
  document.getElementById('statManual').textContent = manualCount;

  histSection.style.display = 'block';
  var item = document.createElement('div');
  item.className = 'history-item'+(isDup?' dup':'');
  item.innerHTML = '<span class="hi-num">#'+count+'</span>'
    +(isDup?'<span class="hi-dup">‚ö†Ô∏èDOBEL</span>':'')
    +'<span class="hi-data">'+(data.length>22?data.slice(0,22)+'‚Ä¶':data)+'</span>'
    +'<span class="hi-time">'+ts+'</span>';
  histList.insertBefore(item, histList.firstChild);
  while(histList.children.length>30) histList.removeChild(histList.lastChild);
}

// ‚îÄ‚îÄ Scanner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
btnScan.addEventListener('click', function(){
  if(scanning) stopScan(); else startScan();
});

async function startScan(){
  if(scanMethod==='none'){
    alert('Browser tidak mendukung BarcodeDetector. Gunakan Chrome terbaru.');
    return;
  }
  statusBar.style.display='block';
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}
    });
    scanVideo.srcObject = stream;
    await scanVideo.play();
    scanning = true;
    scanWrapper.classList.add('active');
    btnScan.textContent = '‚èπ Stop Scan';
    btnScan.className = 'btn btn-stop';
    statusBar.textContent = 'üîç Scanning...';
    statusBar.className = 'status-bar scanning';
    raf = requestAnimationFrame(tick);
  }catch(e){
    statusBar.textContent = '‚ùå Tidak bisa akses kamera: '+e.message;
    statusBar.className = 'status-bar error';
  }
}

function stopScan(){
  scanning = false;
  if(stream){ stream.getTracks().forEach(function(t){ t.stop(); }); stream=null; }
  if(raf){ cancelAnimationFrame(raf); raf=null; }
  scanWrapper.classList.remove('active','dup-mode');
  dupAlert.classList.remove('show');
  btnScan.textContent = 'üì∑ Mulai Scan QR';
  btnScan.className = 'btn btn-primary';
  statusBar.style.display = 'none';
}

async function tick(){
  if(!scanning) return;
  raf = requestAnimationFrame(tick)

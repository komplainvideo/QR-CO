<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="QR Counter">
<meta name="theme-color" content="#0a0a0f">
<title>QR Counter</title>
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0f;color:#e8e8f0;font-family:sans-serif;padding:16px;max-width:420px;margin:0 auto}
h1{text-align:center;color:#00ff88;font-size:1.8rem;margin:16px 0 4px}
.sub{text-align:center;color:#6b6b80;font-size:0.8rem;margin-bottom:16px}
.counter-box{background:#13131a;border:1px solid #1e1e2e;border-radius:16px;padding:24px;text-align:center;margin:12px 0}
.num{font-size:5rem;font-weight:800;color:#00ff88;font-family:monospace;line-height:1}
.num.warn{color:#ff4466}
.lbl{font-size:0.7rem;letter-spacing:4px;color:#6b6b80;margin-top:8px}
.stats{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin:10px 0}
.sc{background:#13131a;border:1px solid #1e1e2e;border-radius:10px;padding:10px 4px;text-align:center}
.sc.red{border-color:rgba(255,68,102,0.5);background:rgba(255,68,102,0.08)}
.sv{font-size:1.1rem;font-weight:800;color:#00ff88;font-family:monospace}
.sc.red .sv{color:#ff4466}
.sl{font-size:0.55rem;color:#6b6b80;margin-top:2px}

/* toggle */
.trow{display:flex;align-items:center;justify-content:space-between;background:#13131a;border:1px solid #1e1e2e;border-radius:12px;padding:12px 14px;margin:10px 0}
.tinfo .tt{font-size:0.85rem;font-weight:700}
.tinfo .ts{font-size:0.7rem;color:#6b6b80;margin-top:2px}
.tswitch{width:54px;height:28px;background:#00ff88;border-radius:28px;position:relative;cursor:pointer;transition:background 0.3s;flex-shrink:0;margin-left:12px}
.tswitch.off{background:#444}
.tknob{position:absolute;top:3px;left:29px;width:22px;height:22px;background:white;border-radius:50%;transition:left 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.4)}
.tswitch.off .tknob{left:3px}

/* buttons */
.btn{width:100%;padding:16px;border:none;border-radius:14px;font-size:1rem;font-weight:700;cursor:pointer;margin:6px 0;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-green{background:#00ff88;color:#0a0a0f}
.btn-red{background:#ff4466;color:white}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0}
.btn-orange{background:#ff6b35;color:white;padding:14px;border:none;border-radius:14px;font-size:0.95rem;font-weight:700;cursor:pointer}
.btn-gray{background:#13131a;color:#9ca3af;border:1px solid #1e1e2e;padding:14px;border-radius:14px;font-size:0.95rem;font-weight:700;cursor:pointer}

/* scanner */
#cam-wrap{display:none;border-radius:16px;overflow:hidden;border:2px solid #00ff88;margin:10px 0;position:relative;background:#000}
#cam-wrap.active{display:block}
#cam-wrap.dup{border-color:#ff4466;box-shadow:0 0 20px rgba(255,68,102,0.4)}
video{width:100%;display:block;max-height:300px;object-fit:cover}
.cam-status{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.75);color:#00ff88;font-size:0.85rem;font-weight:700;text-align:center;padding:10px}
.cam-status.dup{color:#ff4466}

/* dup alert */
#dup-box{display:none;background:rgba(255,68,102,0.12);border:2px solid #ff4466;border-radius:14px;padding:16px;text-align:center;margin:10px 0}
#dup-box.show{display:block}
.di{font-size:2rem}
.dt{color:#ff4466;font-weight:800;font-size:1rem;margin-top:4px}
.dd{color:#ffaaaa;font-size:0.72rem;font-family:monospace;margin-top:6px;word-break:break-all}
.dc{color:#ffaa00;font-weight:700;font-size:0.8rem;margin-top:4px}

/* history */
.hist-title{font-size:0.7rem;letter-spacing:3px;color:#6b6b80;margin:16px 0 6px}
.hi{display:flex;align-items:center;background:#13131a;border:1px solid #1e1e2e;border-radius:8px;padding:8px 10px;font-size:0.72rem;font-family:monospace;margin-bottom:4px}
.hi.dup{border-color:rgba(255,68,102,0.4);background:rgba(255,68,102,0.05)}
.hn{color:#00ff88;font-weight:700;margin-right:6px;flex-shrink:0}
.hd-tag{color:#ff4466;font-size:0.6rem;margin-right:4px;flex-shrink:0}
.hd{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:6px}
.ht{color:#6b6b80;font-size:0.62rem;flex-shrink:0}

/* flash */
.flash{position:fixed;inset:0;pointer-events:none;z-index:999;opacity:0;transition:opacity 0.15s}
.flash.ok{background:rgba(0,255,136,0.08)}
.flash.bad{background:rgba(255,68,102,0.15)}
.flash.on{opacity:1}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:100;display:none;align-items:flex-end}
.modal.show{display:flex}
.modal-box{background:#13131a;border:1px solid #1e1e2e;border-radius:24px 24px 0 0;padding:24px;width:100%}
.modal-box h3{font-size:1.1rem;font-weight:800;margin-bottom:14px}
.modal-box input{width:100%;background:#0a0a0f;border:1px solid #1e1e2e;border-radius:10px;padding:12px 14px;color:#e8e8f0;font-size:0.9rem;outline:none;margin-bottom:12px}
.modal-box input:focus{border-color:#00ff88}
.modal-btns{display:flex;gap:10px}
.modal-btns button{flex:1;padding:12px;border:none;border-radius:10px;font-size:0.9rem;font-weight:700;cursor:pointer}
.mbtn-ok{background:#ff6b35;color:white}
.mbtn-cancel{background:#1e1e2e;color:#9ca3af}
</style>
</head>
<body>

<div class="flash ok" id="fok"></div>
<div class="flash bad" id="fbad"></div>

<h1>‚¨° QR COUNTER</h1>
<p class="sub">// scan & tally QR codes</p>

<div id="dup-box">
  <div class="di">‚ö†Ô∏è</div>
  <div class="dt">‚õî SCAN DOBEL TERDETEKSI!</div>
  <div class="dd" id="dup-data"></div>
  <div class="dc" id="dup-cnt"></div>
</div>

<div class="counter-box">
  <div class="num" id="num">0</div>
  <div class="lbl">TOTAL SCAN</div>
</div>

<div class="stats">
  <div class="sc"><div class="sv" id="s-total">0</div><div class="sl">TOTAL</div></div>
  <div class="sc"><div class="sv" id="s-unik">0</div><div class="sl">UNIK</div></div>
  <div class="sc red"><div class="sv" id="s-dobel">0</div><div class="sl">DOBEL‚ö†Ô∏è</div></div>
  <div class="sc"><div class="sv" id="s-manual">0</div><div class="sl">MANUAL</div></div>
</div>

<div class="trow" onclick="toggleWarn()">
  <div class="tinfo">
    <div class="tt">‚ö†Ô∏è Peringatan Scan Dobel</div>
    <div class="ts">Nada + banner saat QR sama di-scan lagi</div>
  </div>
  <div class="tswitch" id="tswitch"><div class="tknob"></div></div>
</div>

<button class="btn btn-green" id="btn-scan" onclick="handleScan()">üì∑ Mulai Scan QR</button>

<div id="cam-wrap">
  <video id="vid" autoplay muted playsinline webkit-playsinline></video>
  <div class="cam-status" id="cam-st">üîç Arahkan ke QR Code...</div>
</div>

<div class="btn-row">
  <button class="btn-orange" onclick="openManual()">‚ûï Manual</button>
  <button class="btn-gray" onclick="doReset()">üîÑ Reset</button>
</div>

<div id="hist-wrap" style="display:none">
  <div class="hist-title">// RIWAYAT SCAN</div>
  <div id="hist-list"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3>‚ûï Tambah Manual</h3>
    <input type="text" id="m-input" placeholder="Masukkan data / kode...">
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeManual()">Batal</button>
      <button class="mbtn-ok" onclick="confirmManual()">Tambah</button>
    </div>
  </div>
</div>

<script>
// State
var count=0, manualCount=0, data={}, scanning=false, stream=null, raf=null;
var lastCode='', lastTime=0, dupTimer=null;
var warnOn=true, detector=null;

// Toggle warning
function toggleWarn(){
  warnOn=!warnOn;
  var sw=document.getElementById('tswitch');
  sw.style.background=warnOn?'#00ff88':'#444';
  sw.className='tswitch'+(warnOn?'':' off');
}

// Init BarcodeDetector
try{
  detector=new BarcodeDetector({formats:['qr_code','aztec','data_matrix','code_128','code_39','ean_13','ean_8','upc_a','upc_e']});
}catch(e){
  detector=null;
}

// Audio
var actx=null;
function beep(type){
  try{
    if(!actx) actx=new(window.AudioContext||window.webkitAudioContext)();
    if(actx.state==='suspended') actx.resume();
    var t=actx.currentTime;
    var notes=type==='ok'?[[1800,0,0.12],[2400,0.15,0.30]]:[[300,0,0.18],[300,0.22,0.40],[300,0.44,0.62]];
    notes.forEach(function(n){
      var o=actx.createOscillator(),g=actx.createGain();
      o.connect(g);g.connect(actx.destination);
      o.type=type==='ok'?'square':'sawtooth';
      o.frequency.setValueAtTime(n[0],t+n[1]);
      if(type!=='ok') o.frequency.linearRampToValueAtTime(180,t+n[2]-0.02);
      g.gain.setValueAtTime(0.9,t+n[1]);
      g.gain.exponentialRampToValueAtTime(0.001,t+n[2]);
      o.start(t+n[1]);o.stop(t+n[2]);
    });
  }catch(e){}
}
document.addEventListener('touchstart',function(){
  try{if(!actx) actx=new(window.AudioContext||window.webkitAudioContext)();if(actx.state==='suspended')actx.resume();}catch(e){}
},{once:true});

function flash(type){
  var el=document.getElementById(type==='ok'?'fok':'fbad');
  el.classList.add('on');
  setTimeout(function(){el.classList.remove('on');},type==='ok'?200:400);
}

function bumpNum(isDup){
  var el=document.getElementById('num');
  el.style.transform='scale(1.2)';
  el.style.color=isDup?'#ff4466':'#00ff88';
  setTimeout(function(){el.style.transform='';el.style.color=isDup&&warnOn?'#ff4466':'#00ff88';setTimeout(function(){el.style.color='#00ff88';},500);},200);
}

function addScan(val,isManual){
  var now=new Date();
  var ts=now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  var isDup=(data[val]>0);
  count++;
  data[val]=(data[val]||0)+1;
  if(isManual) manualCount++;

  document.getElementById('num').textContent=count;
  bumpNum(isDup&&warnOn);

  var uniq=Object.keys(data).length;
  document.getElementById('s-total').textContent=count;
  document.getElementById('s-unik').textContent=uniq;
  document.getElementById('s-dobel').textContent=count-uniq;
  document.getElementById('s-manual').textContent=manualCount;

  if(isDup&&warnOn){
    flash('bad');beep('warn');
    if(navigator.vibrate) navigator.vibrate([100,50,100,50,100]);
    var db=document.getElementById('dup-box');
    document.getElementById('dup-data').textContent=val.length>40?val.slice(0,40)+'...':val;
    document.getElementById('dup-cnt').textContent='‚ö†Ô∏è QR ini sudah di-scan '+data[val]+'x!';
    db.classList.add('show');
    document.getElementById('cam-wrap').classList.add('dup');
    var st=document.getElementById('cam-st');
    st.className='cam-status dup';
    st.textContent='‚õî DOBEL! '+(val.length>20?val.slice(0,20)+'‚Ä¶':val);
    if(dupTimer) clearTimeout(dupTimer);
    dupTimer=setTimeout(function(){
      db.classList.remove('show');
      document.getElementById('cam-wrap').classList.remove('dup');
      if(scanning){st.className='cam-status';st.textContent='üîç Arahkan ke QR Code...';}
    },3000);
  } else {
    flash('ok');beep('ok');
    if(navigator.vibrate) navigator.vibrate([80,40,80]);
  }

  // History
  document.getElementById('hist-wrap').style.display='block';
  var hl=document.getElementById('hist-list');
  var item=document.createElement('div');
  item.className='hi'+(isDup?' dup':'');
  item.innerHTML='<span class="hn">#'+count+'</span>'+(isDup?'<span class="hd-tag">‚ö†Ô∏èDOBEL</span>':'')+'<span class="hd">'+(val.length>22?val.slice(0,22)+'‚Ä¶':val)+'</span><span class="ht">'+ts+'</span>';
  hl.insertBefore(item,hl.firstChild);
  while(hl.children.length>30) hl.removeChild(hl.lastChild);
}

// Scan button
function handleScan(){
  if(scanning){ stopScan(); } else { startScan(); }
}

async function startScan(){
  if(!detector){
    try{ detector=new BarcodeDetector({formats:['qr_code']}); }
    catch(e){ alert('Browser tidak support scan QR. Gunakan Chrome versi terbaru.'); return; }
  }
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    var vid=document.getElementById('vid');
    vid.srcObject=stream;
    await vid.play();
    scanning=true;
    document.getElementById('cam-wrap').classList.add('active');
    document.getElementById('btn-scan').textContent='‚èπ Stop Scan';
    document.getElementById('btn-scan').className='btn btn-red';
    raf=requestAnimationFrame(tick);
  }catch(e){
    alert('Tidak bisa akses kamera: '+e.message);
  }
}

function stopScan(){
  scanning=false;
  if(stream){stream.getTracks().forEach(function(t){t.stop();});stream=null;}
  if(raf){cancelAnimationFrame(raf);raf=null;}
  document.getElementById('cam-wrap').classList.remove('active','dup');
  document.getElementById('dup-box').classList.remove('show');
  document.getElementById('btn-scan').textContent='üì∑ Mulai Scan QR';
  document.getElementById('btn-scan').className='btn btn-green';
}

async function tick(){
  if(!scanning) return;
  raf=requestAnimationFrame(tick);
  var vid=document.getElementById('vid');
  if(vid.readyState<vid.HAVE_ENOUGH_DATA||vid.videoWidth===0) return;
  try{
    var codes=await detector.detect(vid);
    if(codes&&codes.length>0){
      var val=codes[0].rawValue;
      var now=Date.now();
      if(val!==lastCode||now-lastTime>2500){
        lastCode=val;lastTime=now;
        addScan(val,false);
        if(!(warnOn&&data[val]>1)){
          var st=document.getElementById('cam-st');
          st.className='cam-status';
          st.textContent='‚úÖ '+(val.length>25?val.slice(0,25)+'‚Ä¶':val);
          setTimeout(function(){if(scanning){st.textContent='üîç Arahkan ke QR Code...';}},1200);
        }
      }
    }
  }catch(e){}
}

// Manual
function openManual(){
  document.getElementById('modal').classList.add('show');
  setTimeout(function(){document.getElementById('m-input').focus();},150);
}
function closeManual(){
  document.getElementById('modal').classList.remove('show');
  document.getElementById('m-input').value='';
}
function confirmManual(){
  var v=document.getElementById('m-input').value.trim();
  if(v){addScan(v,true);closeManual();}
}
document.getElementById('m-input').addEventListener('keydown',function(e){if(e.key==='Enter')confirmManual();});
document.getElementById('modal').addEventListener('click',function(e){if(e.target===this)closeManual();});

// Reset
function doReset(){
  if(count===0) return;
  if(!confirm('Reset semua counter dan riwayat?')) return;
  count=0;manualCount=0;data={};lastCode='';lastTime=0;
  document.getElementById('num').textContent='0';
  ['s-total','s-unik','s-dobel','s-manual'].forEach(function(id){document.getElementById(id).textContent='0';});
  document.getElementById('hist-list').innerHTML='';
  document.getElementById('hist-wrap').style.display='none';
  document.getElementById('dup-box').classList.remove('show');
}

// SW
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(function(){});
</script>
</body>
</html>

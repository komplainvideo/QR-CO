<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="QR Counter">
  <title>QR Counter</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root{--bg:#0a0a0f;--card:#13131a;--border:#1e1e2e;--accent:#00ff88;--accent2:#ff6b35;--text:#e8e8f0;--muted:#6b6b80;--danger:#ff4466;--warn:#ffaa00}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,255,136,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,136,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
    .app{position:relative;z-index:1;max-width:420px;margin:0 auto;padding:20px 16px 40px}
    .header{text-align:center;padding:24px 0 16px}
    .header h1{font-size:2.2rem;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,var(--accent),#00ccff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:var(--muted);font-size:0.8rem;margin-top:4px;font-family:monospace}

    .status-bar{text-align:center;font-size:0.75rem;font-family:monospace;color:var(--muted);padding:8px 12px;margin-bottom:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;transition:all 0.3s}
    .status-bar.ready{color:var(--accent);border-color:rgba(0,255,136,0.3)}
    .status-bar.error{color:var(--danger);border-color:rgba(255,68,102,0.3)}
    .status-bar.scanning{color:#00ccff;border-color:rgba(0,204,255,0.3)}

    /* DUPLICATE WARNING BANNER */
    .dup-alert{
      display:none;position:relative;
      background:rgba(255,50,50,0.15);
      border:2px solid var(--danger);
      border-radius:16px;padding:16px;
      text-align:center;margin:10px 0;
      animation:dupPulse 0.5s ease;
    }
    .dup-alert.show{display:block}
    @keyframes dupPulse{
      0%{transform:scale(0.95);opacity:0}
      50%{transform:scale(1.03)}
      100%{transform:scale(1);opacity:1}
    }
    .dup-alert .dup-icon{font-size:2rem;display:block;margin-bottom:4px}
    .dup-alert .dup-title{font-size:1.1rem;font-weight:800;color:var(--danger);letter-spacing:1px}
    .dup-alert .dup-data{font-size:0.75rem;color:#ffaaaa;font-family:monospace;margin-top:6px;word-break:break-all}
    .dup-alert .dup-count{font-size:0.8rem;color:var(--warn);margin-top:4px;font-weight:700}

    /* Flash overlays */
    .success-flash{position:fixed;inset:0;background:rgba(0,255,136,0.1);pointer-events:none;z-index:999;opacity:0;transition:opacity 0.15s}
    .success-flash.show{opacity:1}
    .danger-flash{position:fixed;inset:0;background:rgba(255,50,50,0.15);pointer-events:none;z-index:999;opacity:0;transition:opacity 0.15s}
    .danger-flash.show{opacity:1}

    .offline-badge{display:none;text-align:center;font-size:0.7rem;font-family:monospace;color:var(--warn);background:rgba(255,170,0,0.1);border:1px solid rgba(255,170,0,0.3);border-radius:8px;padding:6px 12px;margin-bottom:8px}
    .offline-badge.show{display:block}

    .counter-display{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px 20px;text-align:center;margin:12px 0;position:relative;overflow:hidden}
    .counter-display::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
    .counter-number{font-size:5rem;font-weight:800;font-family:monospace;color:var(--accent);line-height:1;text-shadow:0 0 40px rgba(0,255,136,0.3);transition:transform 0.1s ease}
    .counter-number.bump{transform:scale(1.15)}
    .counter-number.bump-warn{transform:scale(1.15);color:var(--danger)!important;text-shadow:0 0 40px rgba(255,68,102,0.5)!important}
    .counter-label{font-size:0.7rem;letter-spacing:4px;color:var(--muted);margin-top:8px;font-family:monospace}
    .last-scan{font-size:0.75rem;color:var(--muted);margin-top:10px;font-family:monospace;word-break:break-all;padding:8px 12px;background:rgba(0,255,136,0.05);border-radius:8px;display:none}
    .last-scan.show{display:block}
    .last-scan span{color:var(--accent)}

    .stats-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin:10px 0}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 6px;text-align:center}
    .stat-card.warn-card{border-color:rgba(255,68,102,0.4);background:rgba(255,68,102,0.05)}
    .stat-card .sv{font-size:1.2rem;font-weight:800;font-family:monospace;color:var(--accent)}
    .stat-card.warn-card .sv{color:var(--danger)}
    .stat-card .sl{font-size:0.55rem;color:var(--muted);letter-spacing:1px;margin-top:2px}

    .btn-row{display:flex;gap:10px;margin:10px 0}
    .btn{flex:1;padding:14px;border:none;border-radius:14px;font-size:0.95rem;font-weight:700;cursor:pointer;transition:all 0.15s ease;display:flex;align-items:center;justify-content:center;gap:6px}
    .btn:active{transform:scale(0.96)}
    .btn-primary{background:var(--accent);color:#0a0a0f}
    .btn-stop{background:var(--danger);color:#fff}
    .btn-manual{background:var(--accent2);color:#fff}
    .btn-reset{background:var(--card);color:var(--muted);border:1px solid var(--border)}

    #scanner-wrapper{display:none;border-radius:20px;overflow:hidden;margin:12px 0;border:2px solid var(--accent);box-shadow:0 0 30px rgba(0,255,136,0.2);position:relative;background:#000}
    #scanner-wrapper.active{display:block}
    #scanner-wrapper.dup-mode{border-color:var(--danger);box-shadow:0 0 30px rgba(255,68,102,0.4)}
    #scanner-video{width:100%;display:block;max-height:320px;object-fit:cover}
    #scanner-canvas{display:none}
    .scan-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .scan-frame{width:200px;height:200px;position:relative}
    .sf-tl,.sf-tr,.sf-br,.sf-bl{position:absolute;width:30px;height:30px;border-color:var(--accent);border-style:solid}
    .sf-tl{top:0;left:0;border-width:3px 0 0 3px}
    .sf-tr{top:0;right:0;border-width:3px 3px 0 0}
    .sf-br{bottom:0;right:0;border-width:0 3px 3px 0}
    .sf-bl{bottom:0;left:0;border-width:0 0 3px 3px}
    .scan-line{position:absolute;top:0;left:10px;right:10px;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scanAnim 2s linear infinite;box-shadow:0 0 8px var(--accent)}
    @keyframes scanAnim{0%{top:10px}100%{top:calc(100% - 12px)}}
    .scan-status{position:absolute;bottom:0;left:0;right:0;text-align:center;font-size:0.85rem;font-family:monospace;background:rgba(0,0,0,0.7);padding:10px;font-weight:700}
    .scan-status.ok{color:var(--accent)}
    .scan-status.dup{color:var(--danger);animation:blinkStatus 0.4s ease 3}
    @keyframes blinkStatus{0%,100%{opacity:1}50%{opacity:0.3}}

    .history-section{margin:12px 0}
    .history-title{font-size:0.7rem;letter-spacing:3px;color:var(--muted);font-family:monospace;margin-bottom:8px}
    .history-list{max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:4px}
    .history-item{display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:0.75rem;font-family:monospace;animation:slideIn 0.3s ease}
    .history-item.is-dup{border-color:rgba(255,68,102,0.4);background:rgba(255,68,102,0.05)}
    @keyframes slideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    .hi-num{color:var(--accent);font-weight:700;margin-right:6px;flex-shrink:0}
    .hi-dup{color:var(--danger);font-size:0.65rem;margin-right:4px;flex-shrink:0}
    .hi-data{color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:8px}
    .hi-time{color:var(--muted);font-size:0.65rem;flex-shrink:0}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;display:none;align-items:flex-end;backdrop-filter:blur(4px)}
    .modal-overlay.show{display:flex}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:24px;width:100%;animation:slideUp 0.3s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal h3{font-size:1.1rem;font-weight:800;margin-bottom:16px}
    .modal input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:monospace;font-size:0.9rem;outline:none;margin-bottom:12px}
    .modal input:focus{border-color:var(--accent)}
    .modal-btns{display:flex;gap:10px}
    .modal-btns .btn{flex:1}
  </style>
</head>
<body>
<div class="success-flash" id="flashOk"></div>
<div class="danger-flash" id="flashWarn"></div>

<div class="app">
  <div class="header">
    <h1>‚¨° QR COUNTER</h1>
    <p>// scan & tally QR codes</p>
  </div>

  <div class="offline-badge" id="offlineBadge">üì¥ Mode Offline ‚Äî Semua fitur berjalan normal</div>
  <div class="status-bar" id="statusBar">‚è≥ Memuat...</div>

  <!-- DUPLICATE ALERT BANNER -->
  <div class="dup-alert" id="dupAlert">
    <span class="dup-icon">‚ö†Ô∏è</span>
    <div class="dup-title">‚õî SCAN DOBEL TERDETEKSI!</div>
    <div class="dup-data" id="dupData">‚Äî</div>
    <div class="dup-count" id="dupCount">Sudah di-scan 2x</div>
  </div>

  <div class="counter-display">
    <div class="counter-number" id="counterNum">0</div>
    <div class="counter-label">TOTAL SCAN</div>
    <div class="last-scan" id="lastScan">Last: <span id="lastData">‚Äî</span></div>
  </div>

  <div class="stats-row">
    <div class="stat-card"><div class="sv" id="statTotal">0</div><div class="sl">TOTAL</div></div>
    <div class="stat-card"><div class="sv" id="statUniq">0</div><div class="sl">UNIK</div></div>
    <div class="stat-card warn-card"><div class="sv" id="statDupl">0</div><div class="sl">DOBEL ‚ö†Ô∏è</div></div>
    <div class="stat-card"><div class="sv" id="statManual">0</div><div class="sl">MANUAL</div></div>
  </div>

  <!-- TOGGLE PERINGATAN DOBEL -->
  <div style="display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin:10px 0">
    <div>
      <div style="font-size:0.85rem;font-weight:700;color:var(--text)">‚ö†Ô∏è Peringatan Scan Dobel</div>
      <div style="font-size:0.7rem;color:var(--muted);margin-top:2px;font-family:monospace">Nada + banner saat QR sama di-scan lagi</div>
    </div>
    <div id="toggleBtn" onclick="
      var cb=document.getElementById('toggleDup');
      cb.checked=!cb.checked;
      cb.dispatchEvent(new Event('change'));
    " style="position:relative;display:inline-block;width:56px;height:30px;flex-shrink:0;margin-left:12px;cursor:pointer;user-select:none">
      <input type="checkbox" id="toggleDup" checked style="display:none">
      <div id="toggleSlider" style="position:absolute;inset:0;background:var(--accent);border-radius:30px;transition:0.3s">
        <div id="toggleThumb" style="position:absolute;height:24px;width:24px;left:29px;top:3px;background:white;border-radius:50%;transition:0.3s;box-shadow:0 1px 4px rgba(0,0,0,0.3)"></div>
      </div>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn btn-primary" id="btnScan">üì∑ Mulai Scan QR</button>
  </div>

  <div id="scanner-wrapper">
    <video id="scanner-video" autoplay muted playsinline webkit-playsinline></video>
    <canvas id="scanner-canvas"></canvas>
    <div class="scan-overlay">
      <div class="scan-frame">
        <div class="sf-tl"></div><div class="sf-tr"></div>
        <div class="sf-br"></div><div class="sf-bl"></div>
        <div class="scan-line"></div>
      </div>
    </div>
    <div class="scan-status ok" id="scanStatus">üîç Arahkan ke QR Code...</div>
  </div>

  <div class="btn-row">
    <button class="btn btn-manual" id="btnManual">‚ûï Manual</button>
    <button class="btn btn-reset" id="btnReset">üîÑ Reset</button>
  </div>

  <div class="history-section" id="historySection" style="display:none">
    <div class="history-title">// RIWAYAT SCAN</div>
    <div class="history-list" id="historyList"></div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>‚ûï Tambah Manual</h3>
    <input type="text" id="manualInput" placeholder="Masukkan data / kode...">
    <div class="modal-btns">
      <button class="btn btn-reset" id="modalCancel">Batal</button>
      <button class="btn btn-manual" id="modalConfirm">Tambah</button>
    </div>
  </div>
</div>

<script>
const statusBar=document.getElementById('statusBar');
const counterEl=document.getElementById('counterNum');
const lastScanEl=document.getElementById('lastScan');
const lastDataEl=document.getElementById('lastData');
const scannerWrapper=document.getElementById('scanner-wrapper');
const video=document.getElementById('scanner-video');
const btnScan=document.getElementById('btnScan');
const histSection=document.getElementById('historySection');
const histList=document.getElementById('historyList');
const dupAlert=document.getElementById('dupAlert');
const dupData=document.getElementById('dupData');
const dupCount=document.getElementById('dupCount');

let count=0,manualCount=0,scannedData={},scanning=false,stream=null,raf=null;
let dupWarningOn=true;
let lastScanned='',lastScannedTime=0;
let audioCtx=null,detector=null,scanMethod='none';
let dupTimeout=null;

// Offline
function updateOnlineStatus(){ document.getElementById('offlineBadge').classList.toggle('show',!navigator.onLine); }
window.addEventListener('online',updateOnlineStatus);
window.addEventListener('offline',updateOnlineStatus);
updateOnlineStatus();

// Init BarcodeDetector
async function initScanner(){
  if('BarcodeDetector' in window){
    try{
      const formats=await BarcodeDetector.getSupportedFormats();
      if(formats.includes('qr_code')){
        detector=new BarcodeDetector({formats:['qr_code','aztec','data_matrix','pdf417','code_128','code_39','ean_13','ean_8','upc_a','upc_e']});
        scanMethod='barcodedetector';
        statusBar.textContent='‚úÖ Scanner siap (Mode Native)';
        statusBar.className='status-bar ready';
        setTimeout(()=>{ statusBar.style.display='none'; },2000);
        return;
      }
    }catch(e){}
  }
  statusBar.textContent='‚ùå Browser tidak mendukung. Gunakan Chrome terbaru.';
  statusBar.className='status-bar error';
}
window.addEventListener('load',()=>{
  initScanner();
  // Init toggle
  const toggleDup=document.getElementById('toggleDup');
  const toggleSlider=document.getElementById('toggleSlider');
  const toggleThumb=document.getElementById('toggleThumb');
  if(toggleDup){
    toggleDup.addEventListener('change',()=>{
      dupWarningOn=toggleDup.checked;
      toggleSlider.style.background=dupWarningOn?'var(--accent)':'#444';
      toggleThumb.style.left=dupWarningOn?'26px':'3px';
    });
  }
});

// Audio init
document.addEventListener('touchstart',()=>{
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
},{once:true});

function initAudio(){
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
}

// Normal beep (scan OK)
function playBeepOK(){
  try{
    initAudio();
    const t=audioCtx.currentTime;
    [[1800,0,0.12],[2400,0.15,0.30]].forEach(([freq,start,end])=>{
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.connect(g);g.connect(audioCtx.destination);
      o.type='square';o.frequency.setValueAtTime(freq,t+start);
      g.gain.setValueAtTime(0.8,t+start);
      g.gain.exponentialRampToValueAtTime(0.001,t+end);
      o.start(t+start);o.stop(t+end);
    });
  }catch(e){}
}

// Warning beep (scan dobel) - nada rendah berulang
function playBeepWARN(){
  try{
    initAudio();
    const t=audioCtx.currentTime;
    // 3x beep rendah cepat
    [0, 0.20, 0.40].forEach(start=>{
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.connect(g);g.connect(audioCtx.destination);
      o.type='sawtooth';
      o.frequency.setValueAtTime(300,t+start);
      o.frequency.linearRampToValueAtTime(200,t+start+0.15);
      g.gain.setValueAtTime(1.0,t+start);
      g.gain.exponentialRampToValueAtTime(0.001,t+start+0.18);
      o.start(t+start);o.stop(t+start+0.18);
    });
  }catch(e){}
}

function flashOK(){ const f=document.getElementById('flashOk'); f.classList.add('show'); setTimeout(()=>f.classList.remove('show'),200); }
function flashWARN(){ const f=document.getElementById('flashWarn'); f.classList.add('show'); setTimeout(()=>f.classList.remove('show'),400); }
function bump(warn=false){
  counterEl.classList.remove('bump','bump-warn');
  void counterEl.offsetWidth;
  counterEl.classList.add(warn?'bump-warn':'bump');
  setTimeout(()=>counterEl.classList.remove('bump','bump-warn'),200);
}

function showDupAlert(data, times){
  dupData.textContent = data.length>40 ? data.slice(0,40)+'...' : data;
  dupCount.textContent = `‚ö†Ô∏è QR ini sudah di-scan ${times}x!`;
  dupAlert.classList.add('show');
  scannerWrapper.classList.add('dup-mode');
  if(dupTimeout) clearTimeout(dupTimeout);
  dupTimeout = setTimeout(()=>{
    dupAlert.classList.remove('show');
    scannerWrapper.classList.remove('dup-mode');
  }, 3000);
}

function addScan(data, isManual=false){
  const now=new Date();
  const timeStr=now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const isDup = scannedData[data] > 0;
  count++;
  scannedData[data]=(scannedData[data]||0)+1;
  if(isManual) manualCount++;

  counterEl.textContent=count;

  if(isDup && dupWarningOn){
    // DUPLICATE! dengan peringatan
    bump(true);
    flashWARN();
    playBeepWARN();
    showDupAlert(data, scannedData[data]);
    if(navigator.vibrate) navigator.vibrate([100,50,100,50,100]);
    document.getElementById('scanStatus').className='scan-status dup';
    document.getElementById('scanStatus').textContent='‚õî DOBEL! '+( data.length>20?data.slice(0,20)+'‚Ä¶':data);
    setTimeout(()=>{
      if(scanning){
        document.getElementById('scanStatus').className='scan-status ok';
        document.getElementById('scanStatus').textContent='üîç Arahkan ke QR Code...';
      }
    },2000);
  } else {
    // NEW scan atau mode peringatan dimatikan
    bump(false);
    flashOK();
    playBeepOK();
    if(navigator.vibrate) navigator.vibrate([80,40,80]);
  }

  lastDataEl.textContent=data.length>30?data.slice(0,30)+'...':data;
  lastScanEl.classList.add('show');

  const uniq=Object.keys(scannedData).length;
  const totalDup=count-uniq;
  document.getElementById('statTotal').textContent=count;
  document.getElementById('statUniq').textContent=uniq;
  document.getElementById('statDupl').textContent=totalDup;
  document.getElementById('statManual').textContent=manualCount;

  histSection.style.display='block';
  const item=document.createElement('div');
  item.className='history-item'+(isDup?' is-dup':'');
  item.innerHTML=`<span class="hi-num">#${count}</span>${isDup?'<span class="hi-dup">‚ö†Ô∏èDOBEL</span>':''}<span class="hi-data">${data.length>22?data.slice(0,22)+'‚Ä¶':data}</span><span class="hi-time">${timeStr}</span>`;
  histList.insertBefore(item,histList.firstChild);
  while(histList.children.length>30) histList.removeChild(histList.lastChild);
}

btnScan.addEventListener('click',()=>{ if(scanning) stopScan(); else startScan(); });

async function startScan(){
  if(scanMethod==='none'){ alert('Browser tidak mendukung. Gunakan Chrome te
